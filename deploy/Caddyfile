# Magnetic Cloud — Caddy reverse proxy config
#
# Prerequisites:
#   1. DNS: *.fujs.dev → server IP (wildcard A record)
#   2. Caddy built with DNS challenge plugin (caddy-dns/cloudflare)
#   3. Set CF_API_TOKEN env var for Cloudflare DNS challenge
#
# Usage:
#   CF_API_TOKEN=... caddy run --config /etc/caddy/Caddyfile
#
# The control plane pushes dynamic route config via Caddy's admin API
# (localhost:2019). This Caddyfile is the static base config only.

{
	email admin@fujs.dev

	# Enable admin API for dynamic config updates from control plane
	admin localhost:2019
}

# Control plane API
api.fujs.dev {
	encode gzip zstd
	reverse_proxy localhost:4000
}

# Platform homepage / marketing site
fujs.dev {
	encode gzip zstd
	reverse_proxy localhost:4000
}

# Wildcard: all app subdomains
# Uses Cloudflare DNS challenge for wildcard TLS cert.
# Rewrites /{path} → /apps/{subdomain}/{path} so the platform server
# routes correctly, and passes X-Subdomain so SSR emits root-relative paths.
*.fujs.dev {
	tls {
		dns cloudflare {env.CF_API_TOKEN}
	}

	encode gzip zstd

	# Extract subdomain and rewrite path
	@subdomain host *.fujs.dev
	handle @subdomain {
		# Rewrite: /foo → /apps/{subdomain}/foo
		rewrite * /apps/{labels.2}{uri}
		reverse_proxy localhost:3003 {
			header_up X-Subdomain {labels.2}
		}
	}
}
